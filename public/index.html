<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Iframe SDK Modal</title>
</head>
<body>
  <h1>Iframe SDK Example</h1>
  <button id="open-sdk-btn">Open Modal</button>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Dynamically load the SDK script
      const script = document.createElement("script");
      script.src = "https://gilded-bubblegum-2a10d0.netlify.app/my-iframe-sdk.js"; // Replace with your SDK URL
      script.onload = function() {
        console.log("SDK Loaded");
        // Now define your SDK
        window.MyIframeSDK = window.MyIframeSDK || {};

        // Define modal and SDK logic
        (function () {
          const modalHTML = `
            <div id="my-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:9999;">
              <div style="background:white;padding:20px;border-radius:8px;width:80%;height:80%;position:relative;">
                <button id="my-close-btn" style="position:absolute;top:10px;right:10px;background-color:#FF0000;color:white;border:none;padding:10px;cursor:pointer;border-radius:5px;">Close</button>
                <iframe id="my-iframe" src="https://chatfactorynuturenowmvp.pathfactory-development.com/aichat/baremetal" style="width:100%;height:100%;border:none;"></iframe>
              </div>
            </div>`;
          document.body.insertAdjacentHTML("beforeend", modalHTML);

          const modal = document.getElementById("my-modal");
          const iframe = document.getElementById("my-iframe");
          const closeBtn = document.getElementById("my-close-btn");

          closeBtn.addEventListener("click", () => {
            modal.style.display = "none";
          });

          window.MyIframeSDK = {
            openWithInput: function (inputValue) {
              modal.style.display = "flex"; // Show the modal
              const message = {
                type: "MY_IFRAME_SDK_INPUT",
                input: inputValue
              };
              const sendMessage = () => iframe.contentWindow.postMessage(message, "https://chatfactorynuturenowmvp.pathfactory-development.com");

              // Ensure iframe is loaded before sending message
              if (iframe.contentWindow && iframe.contentDocument.readyState === 'complete') {
                sendMessage(); // If iframe is already loaded
              } else {
                iframe.onload = sendMessage; // Set message after iframe loads
              }
            }
          };

          // Attach click handler AFTER SDK is defined
          document.getElementById("open-sdk-btn").addEventListener("click", () => {
            if (window.MyIframeSDK) {
              MyIframeSDK.openWithInput("Hello");
            } else {
              console.error("SDK not loaded yet");
            }
          });
        })();
      };
      script.onerror = function() {
        console.error("SDK failed to load");
      };

      // Append the script to load the SDK
      document.body.appendChild(script);
    });
  </script>
</body>
</html>
